## å‰è¨€

æˆ‘æ˜¯ä¸å¤ªå–œæ¬¢ OpenWRT çš„ï¼Œç›¸æ¯”æ¥è¯´ RouterOS æ˜¯æˆ‘æ›´ä¸­æ„çš„ã€‚ä¸è¿‡ä¸ºäº†å®ç° CPEï¼Œè¿˜å¸Œæœ›åŠŸèƒ½èƒ½å¤Ÿä¸°å¯Œä¸€äº›ï¼Œè¿˜æƒ³è¦ç½‘å£å¤šä¸€äº›ï¼Œè¿˜æƒ³è¦æˆæœ¬ä½ä¸€äº›ï¼Œçœ‹èµ·æ¥ä¹Ÿåªèƒ½é€‰æ‹©ä¸€äº›å¼€å‘æ¿ï¼Œæ‰€ä»¥åœ¨å‰æ®µæ—¶é—´æˆ‘ä¹°äº†ä¸€ä¸ª MT7621 çš„å¼€å‘æ¿ã€‚

ç„¶åæ’ä¸Š WIFI (MT7612EN + MT7922) å’Œ 4G (ç§»è¿œ EC20) æ¨¡å—åï¼Œå‘ç°è¿™äº›æ¨¡å—å¹¶ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œè™½ç„¶ä»–ä»¬ç¡®å®æ˜¾ç¤ºåœ¨ lsusb ä¸­äº†ã€‚

ç®€å•çš„æœäº†ä¸€äº›æ–‡æ¡£ï¼Œå‘ç°éœ€è¦ kmodï¼Œç„¶åå»è£… kmod çš„æ—¶å€™å‘ç°è£…ä¸ä¸Šã€‚å®Œçƒäº†ï¼Œæˆ‘çŒœæˆ‘éœ€è¦ç¼–è¯‘ OpenWRT äº†ã€‚

äºæ˜¯å’Œå•†å®¶è¦åˆ°äº†ä¸ªå¼€å‘èµ„æ–™ï¼Œå•†å®¶å¾ˆçˆ½å¿«çš„å°±ç»™äº†ã€‚è§£å‹ä¹‹åï¼Œæˆ‘å…ˆç…§ç€å•†å®¶å‘çš„èµ„æ–™å’Œæ–‡æ¡£ç…§è‘«èŠ¦ç”»ç“¢çš„ç¼–è¯‘äº†ä¸€ä¸ªå›ºä»¶å‡ºæ¥ï¼Œå¹¶ä¸”å¾ˆå¿«çš„åˆ·å…¥äº†è®¾å¤‡ï¼Œå‘ç°é—®é¢˜å¹¶ä¸åƒæˆ‘ä¹‹å‰æƒ³çš„é‚£ä¹ˆç®€å•...

## è°ƒæŸ¥

å› ä¸ºæˆ‘ä¸€ç›´ä¸æ€ä¹ˆå…³æ³¨ OpenWRTï¼Œæˆ‘æ­¤æ—¶å¹¶ä¸çŸ¥é“åº”è¯¥æ€ä¹ˆå¤„ç†ä¸‹é¢è¿™äº›åœ¨æˆ‘è„‘å­é‡Œæµ®ç°å‡ºæ¥çš„é—®é¢˜ï¼š

- æˆ‘éœ€è¦åœ¨ç¼–è¯‘çš„æ—¶å€™å°±å°† kmod ä¸€èµ·ç¼–è¯‘å‡ºæ¥ï¼Ÿ
- å¦‚æœæˆ‘çš„é—®é¢˜æ²¡æœ‰å¾—åˆ°è§£å†³ï¼Œæˆ–æ˜¯æˆ‘æ›´æ¢äº†å…¶ä»–çš„ç¡¬ä»¶ï¼Œéœ€è¦æ›´å¤šçš„ kmodï¼Œæˆ‘å°±å¯èƒ½éœ€è¦ä¸æ–­çš„ç¼–è¯‘æ›´å¤šçš„ä¸œè¥¿ï¼Ÿ
- éœ€è¦å¼ºåˆ¶å®‰è£… kmodï¼Ÿ
- å®˜æ–¹çš„ opkg Repoï¼Œéš¾é“ä¸èƒ½ä½¿ç”¨åœ¨è‡ªç¼–è¯‘çš„å›ºä»¶ä¸Šï¼Ÿ

è¿™æ˜¯å½“æ—¶æˆ‘è„‘å­é‡Œæ„è¯†åˆ°çš„ä¸œè¥¿ï¼ˆè™½ç„¶æœ‰äº›ç°åœ¨æ¥çœ‹å¹¶ä¸æ˜¯é‚£ä¹ˆå‡†ç¡®ï¼‰

åœ¨æˆ‘æ•´ç†äº†æ€è·¯åï¼Œæˆ‘è®¤ä¸ºå®˜æ–¹çš„å›ºä»¶ä¹Ÿå¿…ç„¶æ˜¯ä¸ª CI/CD æ¥å®Œæˆç¼–è¯‘çš„ï¼Œæ‰€ä»¥ä¸€å®šæœ‰åŠæ³•åœ¨è‡ªç¼–è¯‘å›ºä»¶ä¸Šä½¿ç”¨å®˜æ–¹çš„ opkg Repoã€‚è‡³äºå¼ºåˆ¶å®‰è£…æˆ–è®¸èƒ½è§£å†³å½“ä¸‹çš„é—®é¢˜ï¼Œä½†æ˜¯è‚¯å®šæ˜¯ä¸‹ä¸‹ç­–ã€‚

åŸºäºä¸Šé¢çš„åˆ¤æ–­ï¼Œç»è¿‡äº†ä¸€äº›æœç´¢åæˆ‘ä»ä¸‹é¢çš„ä¸¤ä¸ªæ–‡ç« é‡Œé¢å¼„æ¸…äº†åŸå› ã€‚

https://hamy.io/post/0015/how-to-compile-openwrt-and-still-use-the-official-repository/

https://libremesh.org/development-kernel_vermagic.html

ä½ å¯ä»¥ç›´æ¥å»çœ‹è¿™ä¸¤ä¸ªæ–‡ç« ï¼Œæˆ–æ˜¯ä½ å¯ä»¥ç•™åœ¨è¿™é‡Œç»§ç»­çœ‹æˆ‘çš„æ€»ç»“ã€‚

## åŸå› 

è‡ªç¼–è¯‘å›ºä»¶çš„ kernel ç‰ˆæœ¬ä¸å®˜æ–¹ Repo é‡Œé¢çš„ kmod å®‰è£…åŒ…ä¸­è®°å½•çš„ kernel ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œå‡†ç¡®çš„è¯´æ˜¯ vermagicã€‚

> This is because OpenWRT has a system called â€œvermagicâ€ that ensures you can only install kmod packages with the same settings as the build config settings of the kernel you are running.
> 

OpenWRT é€šè¿‡ä¸€ä¸ªåä¸º vermagic çš„è®°å½•æ¥ç¡®ä¿ä½ åªèƒ½å®‰è£…å…·æœ‰åŒæ ·è®¾ç½®çš„ kmod å®‰è£…åŒ…ã€‚

ä½ å¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹ä½ å½“å‰è¿è¡Œçš„å›ºä»¶çš„ vermagic

```bash
opkg list-installed kernel
```

## é‡æ–°ç¼–è¯‘

ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦ç¼–è¯‘ä¸€ä¸ªä¸å®˜æ–¹ Stable Release å…·æœ‰åŒæ · vermagic çš„è‡ªç¼–è¯‘ç‰ˆæœ¬ï¼Œå¹¶ç¡®ä¿åœ¨åˆ·å…¥è®¾å¤‡åèƒ½å¤Ÿä»å®˜æ–¹çš„ opkg Repo å®‰è£… kmodã€‚

### æŸ¥çœ‹å®˜æ–¹å›ºä»¶çš„ vermagic

å®˜æ–¹å›ºä»¶çš„ vermagic ä»ä¸‹è½½åœ°å€å³å¯ä»¥çœ‹åˆ°ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªã€‚

https://downloads.openwrt.org/releases/23.05.2/targets/ramips/mt7621/kmods/

é‡Œé¢èƒ½å¤Ÿçœ‹åˆ°è¿™æ ·ä¸€ä¸ªç›®å½•: 5.15.137-1-9c242f353867f49a96054ff8c9f2c460ï¼Œå…¶ä¸­ 9c242f353867f49a96054ff8c9f2c460 å°±æ˜¯å®˜æ–¹å›ºä»¶çš„ vermagic

### ç¼–è¯‘ç‰¹å®š vermagic çš„å›ºä»¶

### æ£€å‡ºä»£ç 

ç”±äºä¸Šé¢æˆ‘ä»¬æŸ¥çœ‹çš„æ˜¯ Stable Release 23.05.2 çš„ vermagicï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ£€å‡º Stable Release 23.05.2 çš„ Tagã€‚

```bash
git clone https://git.openwrt.org/openwrt/openwrt.git
cd openwrt
git checkout v23.05.2
```

### æ›´æ–°å¹¶å®‰è£… feeds

```bash
# æ›´æ–°åº“
./scripts/feeds update -a

# ä¸‹è½½è½¯ä»¶åŒ…
./scripts/feeds install -a
```

### è°ƒæ•´ä»£ç 

<aside>
ğŸ’¡ å¦‚æœä½ éœ€è¦ä¿®æ”¹ DTS è¯·åœ¨æ›´æ–°å¹¶å®‰è£… feeds åå¼€å§‹ã€‚æ¯”å¦‚æˆ‘çš„å¼€å‘æ¿ç¡¬ä»¶ä¸ mqmaker WiTi Board å¾ˆåƒï¼Œæ‰€ä»¥æˆ‘éœ€è¦å°†æ­¤è®¾å¤‡çš„ DTS æŒ‰ç…§å•†å®¶æ‰€æä¾›çš„ DTS è¿›è¡Œä¿®æ”¹ã€‚åœ¨ç¼–è¯‘æ—¶å³å¯ä»¥å°†æœºå‹é€‰æ‹©ä¸º mqmaker WiTi Boardã€‚è€Œå¦‚æœä½ çš„è®¾å¤‡æ— éœ€ä¿®æ”¹ DTSï¼Œå®ƒæ˜¯å®˜æ–¹å›ºä»¶ä¸‹è½½åœ°å€é‡Œé¢æœ‰çš„ï¼Œé‚£ä½ åˆä½•å¿…å¦‚æ­¤æŠ˜è…¾çš„ç¼–è¯‘å›ºä»¶å‘¢?

</aside>

### è®¾ç½® .config

è·å– Stable Release 23.05.2 å®˜æ–¹å›ºä»¶çš„ config.buildinfo

```bash
wget -O .config https://downloads.openwrt.org/releases/23.05.2/targets/ramips/mt7621/config.buildinfo
```

è¡¥å…¨ .config

ä¸Šé¢çš„ config æ˜¯ä¸€ä»½ç²¾ç®€çš„é…ç½®ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å¯¹å…¶è¿›è¡Œè¡¥å…¨ã€‚

```bash
make defconfig
```

### æ£€æŸ¥ vermagic

ç¼–è¯‘å®Œæ•´çš„å›ºä»¶ä¼šèŠ±è´¹éå¸¸ä¹…çš„æ—¶é—´ï¼Œä½ è‚¯å®šä¸æƒ³å®Œæˆæ„å»ºåå‘ç° vermagic ä¾æ—§æ˜¯ä¸åŒ¹é…çš„ã€‚æ‰€ä»¥åœ¨ç¼–è¯‘å®Œæ•´å›ºä»¶ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥ä»¥ä»…ç¼–è¯‘å†…æ ¸å¹¶æ£€æŸ¥ vermagicã€‚

```bash
make target/linux/{clean,compile}
```

<aside>
âš ï¸ åœ¨ `make target/linux/{clean,compile}` æ‰§è¡Œä¹‹åï¼Œæœ€ç»ˆå®ƒå¾ˆå¯èƒ½ä¼šå¤±è´¥ï¼Œå¹¶ä¸”ä½ æ­¤æ—¶æ— æ³•æ„å»ºå®Œæ•´çš„å†…æ ¸ï¼ˆå› ä¸ºä½ å°šæœªé¦–å…ˆæ„å»ºå¿…è¦çš„å…ˆå†³æ¡ä»¶ï¼‰ã€‚

ä½†ä¸è¦å®³æ€•ï¼æˆ‘ä»¬æ‰€éœ€è¦çš„ .vermagic æ–‡ä»¶åº”è¯¥åœ¨å¤±è´¥ä¹‹å‰å°±ä¼šç”Ÿæˆï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ç°é˜¶æ®µæ‰€éœ€è¦çš„ã€‚

</aside>

```bash
find build_dir/ -name .vermagic -exec cat {} \;
```

ç¡®è®¤ä½ çœ‹åˆ°çš„ vermagic ä¸å‰é¢æ­¥éª¤ä¸­å¾—åˆ°çš„å®˜æ–¹å›ºä»¶çš„ vermagic æ˜¯ä¸€è‡´çš„ã€‚

### åšé€‚å½“çš„è°ƒæ•´

åœ¨è¿™ä¸€æ­¥ï¼Œä½ å¯ä»¥åšä¸€äº›è‡ªå®šä¹‰çš„æ”¹åŠ¨ã€‚ä½†æ˜¯è¯·æ³¨æ„ï¼Œä¸æ°å½“çš„æ”¹åŠ¨ä¼šå½±å“ vermagicï¼Œ**æˆ‘çš„å»ºè®®æ˜¯è¿™é‡Œåªåšæœºå‹é€‰æ‹©ï¼Œåˆ«çš„ä¸è¦åŠ¨**ã€‚

æˆ–æ˜¯å¦‚æœä½ èƒ½å¿è€æ¼«é•¿çš„ç¼–è¯‘æ—¶é—´ï¼Œå¯ä»¥è·³è¿‡è¿™ä¸€æ­¥éª¤ï¼Œå®ƒå°†ç¼–è¯‘æ‰€æœ‰çš„æœºå‹ã€‚

```bash
make menuconfig
```

### å†æ¬¡æ£€æŸ¥ vermagic

å¦‚æœä½ æ‰§è¡Œè¿‡ `make menuconfig`ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°ç¡®è®¤ vermagic çš„

```bash
make target/linux/{clean,compile}
```

å½“ç„¶ï¼Œåƒå‰é¢çš„æ­¥éª¤ä¸€æ ·ï¼Œè¿™ä¸ªç¼–è¯‘ä¾æ—§å¾ˆå¯èƒ½ä¸ä¼šæˆåŠŸã€‚

```bash
find build_dir/ -name .vermagic -exec cat {} \;
```

å¦‚æœä½ çœ‹åˆ°çš„ vermagic å€¼ä¾æ—§æ˜¯å®˜æ–¹å›ºä»¶çš„ vermagic æ˜¯ä¸€è‡´çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿›è¡Œä¸‹é¢çš„æ­¥éª¤äº†ã€‚å¦‚æœä¸æ˜¯ï¼Œä½ éœ€è¦é‡æ–°æ‰§è¡Œä¸Šé¢çš„å‡ ä¸ªæ­¥éª¤ã€‚æˆ–æ˜¯è€ƒè™‘è·³è¿‡ `make menuconfig`ã€‚

### ä¸‹è½½ç¼–è¯‘æ‰€éœ€è¦çš„èµ„æº

```bash
make download
```

### æ‰§è¡Œç¼–è¯‘

```bash
make V=s
```

è¿™ä¸€æ­¥ä¼šèŠ±è´¹å¾ˆé•¿æ—¶é—´ã€‚ç¼–è¯‘å®Œæˆåï¼Œä½ å°†å¾—åˆ°ä¸€ä¸ªåŒ…å«äº†åŸºç¡€è½¯ä»¶çš„å›ºä»¶ã€‚

åœ¨æˆ‘çš„ä¾‹å­å½“ä¸­ï¼Œå®ƒä¼šå­˜æ”¾åœ¨ `bin/targets/ramips/mt7621/openwrt-23.05.2-ramips-mt7621-mqmaker_witi-squashfs-sysupgrade.bin`ã€‚

ä¸€åˆ‡æ­£å¸¸çš„è¯ï¼Œå®ƒå·²ç»èƒ½å¤Ÿåˆ·å…¥å¹¶å®Œæˆå¯åŠ¨ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨å®˜æ–¹ opkg Repo é•œåƒ kmod æˆ–æ˜¯å…¶ä»– opkg åŒ…çš„å®‰è£…ã€‚

## æ·»åŠ æ›´å¤šçš„åŒ…

è¿™æ˜¯ä¸€ä¸ªå¯é€‰æ­¥éª¤ã€‚

<aside>
ğŸ’¡ ä¸ªäººè®¤ä¸ºï¼Œå¦‚æœæ˜¯è‡ªç”¨çš„æƒ…å†µï¼Œæ²¡æœ‰å¿…è¦å†åšè¿™äº›æ­¥éª¤ï¼Œå› ä¸ºç°åœ¨æˆ‘ä»¬å·²ç»èƒ½å¤Ÿä»å®˜æ–¹ opkg Repo é•œåƒæ‰§è¡Œ opkg çš„å®‰è£…ã€‚

</aside>

å¦‚æœæƒ³è¦åœ¨å›ºä»¶ä¸­å¼•å…¥æ›´å¤šç‰¹å®šçš„åŒ…ï¼ˆä»¥å®ç°åœ¨æ¢å¤å‡ºå‚è®¾ç½®æ—¶ä¸ä¼šä¸¢å¤±ä»–ä»¬ï¼‰ï¼Œé™¤äº†å¯ä»¥åœ¨ç¼–è¯‘çš„æ—¶å€™ä½¿ç”¨ `make menuconfig` è¿›è¡Œæ·»åŠ ï¼ˆè¿™å¯èƒ½éœ€è¦åå¤è°ƒæ•´ä»¥ä¿è¯ vermagic çš„ä¸€è‡´æ€§ï¼Œ**ä½¿ç”¨ Image Builderï¼ˆè¿™ä¸ªå·¥å…·ä¹Ÿä¼šåœ¨ä¸Šä¸€æ­¥çš„ç¼–è¯‘è¿‡ç¨‹ä¸­ä¸€èµ·è·å¾—ã€‚ï¼‰ æ¥è¿›è¡Œåç»­çš„å¤„ç†æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚**

### è§£å‹ Image Builder

```bash
cp bin/targets/ramips/mt7621/openwrt-imagebuilder-23.05.2-ramips-mt7621.Linux-x86_64.tar.xz /home/ares

tar -xf /home/ares/openwrt-imagebuilder-23.05.2-ramips-mt7621.Linux-x86_64.tar.xz
```

### å¤åˆ¶ Base-files

å°†ä¸Šä¸€æ­¥ç¼–è¯‘å‡ºæ¥çš„ `base-files_*_mipsel_24kc.ipk` (ä½äº bin/targets/ramips/mt7621/packages) æ‹·è´åˆ° openwrt-imagebuilder-23.05.2-ramips-mt7621.Linux-x86_64/packagesã€‚

*è¿™æ˜¯é’ˆå¯¹æˆ‘ä»¬çš„ç¡¬ä»¶çš„ OpenWRT æ¡†æ¶æ–‡ä»¶ï¼Œé™¤äº†è¿™ä¸ªå…¶ä»–çš„åŒ…æˆ‘ä»¬éƒ½å¯ä»¥ä½¿ç”¨ Image Builder ä»å®˜æ–¹ä¸‹è½½åˆ°çš„ opkg fileã€‚*

```bash
cp bin/targets/ramips/mt7621/base-files_*_mipsel_24kc.ipk /home/ares/openwrt-imagebuilder-23.05.2-ramips-mt7621.Linux-x86_64/packages
```

### ç”Ÿæˆæ–°çš„å›ºä»¶

```bash
cd /home/ares/imagebuilder-23.05.2-ramips-mt7621.Linux-x86_64

make image \\
PROFILE=mqmaker_witi \\
PACKAGES="pkg1 pkg2 pkg3 -pkg4 -pkg5 -pkg6" \\
FILES="files" \\
DISABLED_SERVICES="svc1 svc2 svc3"
```

<!-- ##{"timestamp":1700236800}## -->